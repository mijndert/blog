<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Eleventy v3.0.0">
    <meta name="fediverse:creator" content="@mijndert@fosstodon.org">
    <!-- <title>Config-driven Terraform</title> -->
    <title>Config-driven Terraform - Mijndert Stuij</title>
    <meta name="description" content="Some improvements in Terraform 1.7: Config-driven Remove and Import block for_each.">
    <link rel="canonical" href="https://mijndertstuij.nl/posts/config-driven-terraform/">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#FAF9F5">
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/feed.xml">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/mocha.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    </noscript>
  </head>
  <body>
    <header>
  <a href="/" aria-label="Back to homepage">
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="32.000000pt" height="32.000000pt" viewBox="0 0 48.000000 48.000000" preserveAspectRatio="xMidYMid meet">
      <g transform="translate(0.000000,48.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
        <path d="M404 459 c-10 -12 -34 -28 -52 -36 -40 -17 -50 -39 -29 -61 19 -19 35 -9 19 11 -7 8 -9 17 -5 20 13 14 23 6 23 -16 0 -29 43 -72 64 -64 9 4 16 17 16 30 0 14 6 40 14 58 15 37 6 79 -17 79 -8 0 -22 -10 -33 -21z m36 -23 c0 -28 -13 -47 -41 -62 -27 -14 -29 -13 -29 6 0 20 44 70 61 70 5 0 9 -6 9 -14z m-20 -86 c0 -5 -7 -10 -16 -10 -8 0 -12 5 -9 10 3 6 10 10 16 10 5 0 9 -4 9 -10z"></path>
        <path d="M156 445 c-112 -40 -171 -186 -115 -285 20 -35 20 -39 5 -68 -20 -39 -21 -81 -1 -88 31 -12 70 9 134 71 62 60 180 229 168 241 -3 3 -28 -27 -55 -68 -84 -124 -188 -228 -229 -228 -16 0 -17 40 -2 74 11 23 13 24 35 9 32 -20 31 -6 -1 19 -80 63 -71 197 18 275 40 35 88 48 145 39 l37 -5 -30 14 c-38 18 -60 18 -109 0z"></path>
        <path d="M416 240 c-18 -96 -64 -152 -148 -181 l-53 -18 38 -1 c96 0 186 107 175 210 l-3 35 -9 -45z"></path>
      </g>
    </svg>
  </a>
</header>
    <main>
      
<h1>Config-driven Terraform</h1>
<p class="muted">Jan 18, 2024</p>
<article><p>Some time ago I wrote about <a href="https://mijndertstuij.nl/posts/terraform-import-blocks/">config-driven import</a> which became available in Terraform 1.5. Import blocks are a way to import existing resources into the statefile, which is useful when you have a bunch of infrastructure that was created manually. Yesterday <a href="https://www.hashicorp.com/blog/terraform-1-7-adds-test-mocking-and-config-driven-remove">Terraform 1.7 was released</a> that extends this functionality with a <code>for_each</code> argument.</p>
<blockquote>
<p>Terraform 1.7 also includes an enhancement for config-driven import: the ability to expand import blocks using for_each loops. Previously you could target a particular instance of a resource in the to attribute of an import block, but you had to write a separate import block for each instance.</p>
</blockquote>
<p>Expanding on my previous blogpost about Import blocks, here's a quick example of how to use the new <code>for_each</code> argument on a list to import multiple Digitalocean Spaces buckets at once.</p>
<pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">digitalocean</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"digitalocean/digitalocean"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">buckets</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span> <span class="token punctuation">=</span> <span class="token string">"bucket-test"</span>
    <span class="token property">"staging"</span> <span class="token punctuation">=</span> <span class="token string">"bucket-staging"</span>
    <span class="token property">"prod"</span>    <span class="token punctuation">=</span> <span class="token string">"bucket-prod"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  <span class="token property">for_each</span> <span class="token punctuation">=</span> local.buckets
  <span class="token property">to</span>       <span class="token punctuation">=</span> digitalocean_spaces_bucket.mybucket<span class="token punctuation">[</span>each.key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token keyword">resource <span class="token type variable">"digitalocean_spaces_bucket"</span></span> <span class="token string">"mybucket"</span> <span class="token punctuation">{</span>
  <span class="token property">for_each</span> <span class="token punctuation">=</span> local.buckets
  <span class="token property">bucket</span>   <span class="token punctuation">=</span> each.value
<span class="token punctuation">}</span></code></pre>
<p>Another great addition in Terraform 1.7 are Remove blocks. There are times when you need to remove a resource from your Statefile, optionally without removing the underlying resource itself. Of course there are CLI commands to accomplish this, but having it available as a Remove block means we can run <code>terraform apply</code> and check the changes before executing them.</p>
<blockquote>
<p>As an alternative to the terraform state rm command, the removed block addresses all of these challenges. Just like the moved and import blocks, state removal can now be performed in bulk and is plannable, so you can be confident that the operation will have the intended effect before modifying state.</p>
</blockquote>
<pre class="language-hcl"><code class="language-hcl"><span class="token keyword">removed</span> <span class="token punctuation">{</span>
  <span class="token property">from</span> <span class="token punctuation">=</span> digitalocean_spaces_bucket.mybucket

  <span class="token comment"># Instruct Terraform not to destroy the underlying resource</span>
  <span class="token keyword">lifecycle</span> <span class="token punctuation">{</span>
    <span class="token property">destroy</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Both of these additions are great improvements to Terraform, and I'm looking forward to using them in my projects. They will ensure I'm much more confident in working with the Statefile which has always been a bit daunting.</p>
</article>

    </main>
    <footer>
  <h2>Connect</h2>
  <p class="compact">Follow me via <a href="/feed.xml">RSS</a>, <a rel="me" href="https://fosstodon.org/@mijndert">Mastodon</a>, or <a href="/connect">other options</a>.</p>
</footer>
  </body>
</html>
