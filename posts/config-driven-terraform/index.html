<!DOCTYPE html>
<html lang="en">
  <head>

    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Eleventy v3.1.1">

    <!-- SEO -->
    <title>
      
        Config-driven Terraform - Mijndert Stuij
      
    </title>
    
    <meta name="description" content="Some improvements in Terraform 1.7: Config-driven Remove and Import block for_each.">
    <meta property="og:description" content="Some improvements in Terraform 1.7: Config-driven Remove and Import block for_each.">
    
    <link rel="canonical" href="https://mijndertstuij.nl/posts/config-driven-terraform/">
    <meta name="robots" content="index, follow">

    <!-- Open Graph -->
    <meta name="fediverse:creator" content="@mijndert@toot.community">
    <meta property="og:title" content="Config-driven Terraform">
    <meta property="og:site_name" content="Mijndert Stuij">
    <meta property="og:url" content="https://mijndertstuij.nl/posts/config-driven-terraform/">
    <meta property="og:type" content="article">

    <!-- Theme color -->
    <meta name="theme-color" content="#eee9dc" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1b1e" media="(prefers-color-scheme: dark)">

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">

    <!-- RSS feeds -->
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/feed.xml">
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/weeknotes-feed.xml">
    <link rel="alternate" type="application/rss+xml" href="https://mijndertstuij.nl/posts-feed.xml">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Font -->
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
  </head>
  
  <body>
    <nav aria-label="Main navigation">
  <ul class="nav">
    
    <li>
      <a href="/" class="nav-link">Mijndert Stuij</a>
    </li>
    
    <li>
      <a href="/blog/" class="nav-link">Blog</a>
    </li>
    
    <li>
      <a href="/weeknotes/" class="nav-link">Week notes</a>
    </li>
    
    <li>
      <a href="/explore/" class="nav-link">Explore</a>
    </li>
    
  </ul>
</nav>

    
    

    <main>
      
<h1>Config-driven Terraform</h1>
<span class="meta">
  <p class="muted">
    Jan 18, 2024
  </p>
</span>
<p>Some time ago I wrote about <a href="https://mijndertstuij.nl/posts/terraform-import-blocks/">config-driven import</a> which became available in Terraform 1.5. Import blocks are a way to import existing resources into the statefile, which is useful when you have a bunch of infrastructure that was created manually. Yesterday <a href="https://www.hashicorp.com/blog/terraform-1-7-adds-test-mocking-and-config-driven-remove">Terraform 1.7 was released</a> that extends this functionality with a <code>for_each</code> argument.</p>
<blockquote>
<p>Terraform 1.7 also includes an enhancement for config-driven import: the ability to expand import blocks using for_each loops. Previously you could target a particular instance of a resource in the to attribute of an import block, but you had to write a separate import block for each instance.</p>
</blockquote>
<p>Expanding on my previous blogpost about Import blocks, here's a quick example of how to use the new <code>for_each</code> argument on a list to import multiple Digitalocean Spaces buckets at once.</p>
<pre class="language-hcl"><code class="language-hcl"><span class="token keyword">terraform</span> <span class="token punctuation">{</span>
  <span class="token keyword">required_providers</span> <span class="token punctuation">{</span>
    <span class="token property">digitalocean</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
      <span class="token property">source</span> <span class="token punctuation">=</span> <span class="token string">"digitalocean/digitalocean"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">locals</span> <span class="token punctuation">{</span>
  <span class="token property">buckets</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span>
    <span class="token property">"test"</span> <span class="token punctuation">=</span> <span class="token string">"bucket-test"</span>
    <span class="token property">"staging"</span> <span class="token punctuation">=</span> <span class="token string">"bucket-staging"</span>
    <span class="token property">"prod"</span>    <span class="token punctuation">=</span> <span class="token string">"bucket-prod"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  <span class="token property">for_each</span> <span class="token punctuation">=</span> local.buckets
  <span class="token property">to</span>       <span class="token punctuation">=</span> digitalocean_spaces_bucket.mybucket<span class="token punctuation">[</span>each.key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>


<span class="token keyword">resource <span class="token type variable">"digitalocean_spaces_bucket"</span></span> <span class="token string">"mybucket"</span> <span class="token punctuation">{</span>
  <span class="token property">for_each</span> <span class="token punctuation">=</span> local.buckets
  <span class="token property">bucket</span>   <span class="token punctuation">=</span> each.value
<span class="token punctuation">}</span></code></pre>
<p>Another great addition in Terraform 1.7 are Remove blocks. There are times when you need to remove a resource from your Statefile, optionally without removing the underlying resource itself. Of course there are CLI commands to accomplish this, but having it available as a Remove block means we can run <code>terraform apply</code> and check the changes before executing them.</p>
<blockquote>
<p>As an alternative to the terraform state rm command, the removed block addresses all of these challenges. Just like the moved and import blocks, state removal can now be performed in bulk and is plannable, so you can be confident that the operation will have the intended effect before modifying state.</p>
</blockquote>
<pre class="language-hcl"><code class="language-hcl"><span class="token keyword">removed</span> <span class="token punctuation">{</span>
  <span class="token property">from</span> <span class="token punctuation">=</span> digitalocean_spaces_bucket.mybucket

  <span class="token comment"># Instruct Terraform not to destroy the underlying resource</span>
  <span class="token keyword">lifecycle</span> <span class="token punctuation">{</span>
    <span class="token property">destroy</span> <span class="token punctuation">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Both of these additions are great improvements to Terraform, and I'm looking forward to using them in my projects. They will ensure I'm much more confident in working with the Statefile which has always been a bit daunting.</p>


    </main>

    <footer aria-label="Site footer">
  <p>Follow me via <a href="/feeds">RSS</a>, 
    <a rel="me" href="https://toot.community/@mijndert" aria-label="Follow me on Mastodon">Mastodon</a>, 
    or <a href="/connect" aria-label="Other connection options">other options</a>.</p>
</footer>
  </body>
</html>
